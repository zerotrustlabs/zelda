on: [push]

jobs:
  regula_tf_job:
    runs-on: ubuntu-latest
    name: Regula Terraform
    steps:
    - uses: actions/checkout@master
    - uses: fugue/regula-action@v3.2.1
      with:
        input_path: .
        rego_paths: example_custom_rule


  regula_tf_plan_job:
    runs-on: ubuntu-latest
    name: Regula on a Terraform plan JSON
    steps:
    - uses: actions/checkout@master
    - uses: hashicorp/setup-terraform@v1
      with:
        terraform_wrapper: false
        terraform_version: 1.2
    - run: |
        terraform init
        terraform plan -refresh=false -out="plan.tfplan"
        terraform show -json plan.tfplan > plan.json
      env:
        # AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        # AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_ACCESS_KEY_ID: "ASIAYZFWRJC4ZZH32TUI"
        AWS_SECRET_ACCESS_KEY: "z0sfVJdC3asmVsLp9lDKGNr7zBaEjei3q+Zy1vWt"
        AWS_SESSION_TOKEN: "IQoJb3JpZ2luX2VjEIf//////////wEaCWV1LXdlc3QtMiJGMEQCICJZekQ1XNLuEG2Cz0X99JB43lag5mPqdf4XhDdtoVpNAiBJXblPYrmIeXhzeY53zZnZODNaaAZvUphOh7PFv61+FiqoAwiQ//////////8BEAMaDDYwMzgyNTcxOTQ4MSIM33JvXLf0MxaEm3WLKvwCHXXrAWMiGoRfU+ECWsCHg55YbYM7NwChyP6Ig2InxGzd0HBOtZ4YVL2XgEgf3zo68pej7uygG4JZO8ZuW7pcpzVaaFt02X9aL6PwHJnW9+T4TF8IfwrMBzgg2nF1xHTsh+zHiqnQPivKGYSOpLOvyMmnx/ok2V0nVOln2yJeeFJIEseZDfwbPgaddJU+0ewKbnvlL+N6z9dyEMEHQ5r2GxkdWLnrCSIiH13Imk/mv0gzN7xKG+bY32UKKLp0uD4KuCNLjsjs8Uz679yMfzri2AH7vsz25lOez7yK5GEwDxSI9nDYwOCeTp8gzGrP3I76Xjr7rJUPw2aNIs8xW4YNRgdHC2GjCV28czyMspi8XXyc0/zMdT2N7VIhCQS+Ic5J5xb/jCC5/lKzsCcnAlyH+f6W/V5xJxsfKn0kuDEFqs5kVI8Mjjy+F6A9Pr7bLx9hCA8Ab3m/wy9RbK0S9lkPz0En2LSzN111lrkdQT1NTwYVir3ITU7RjtKPuo0wnaWdtgY6pwEkZ8241oKwL42gYpS1p0GD9uHdwpgkqgOjEIbx4ORC6761flhWojuIgtyUXRx+CFoFXOYeWR1WkP6N0zE/mKSOXGaAZFJVx7aWp06INoTnUefFDR+JPLDZRl5ZhuYlGW6zbtTLojTBAviiIrdhozponyJT3sOHxwxL+NmdBOO5htW3A5X2SsR4ZYghj7qAt1ex3DA+YS6y5jcfNr6Upf+LGdz6oOSezw=="

    - uses: fugue/regula-action@v3.2.1
      with:
        input_path: infra_tf/plan.json
        input_type: tf-plan
        rego_paths: example_custom_rule
