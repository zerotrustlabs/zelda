on: [push]

jobs:
  regula_tf_job:
    runs-on: ubuntu-latest
    name: Regula Terraform
    steps:
    - uses: actions/checkout@master
    - uses: fugue/regula-action@v3.2.1
      with:
        input_path: .
        rego_paths: policy_custom_rule/fugue_opa


  regula_tf_plan_job:
    runs-on: ubuntu-latest
    name: Regula on a Terraform plan JSON
    steps:
    - uses: actions/checkout@master
    - uses: hashicorp/setup-terraform@v1
      with:
        terraform_wrapper: false
        terraform_version: 1.2
    - run: |
        terraform init
        terraform plan -refresh=false -out="plan.tfplan"
        terraform show -json plan.tfplan > plan.json
      env:
        # AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        # AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_ACCESS_KEY_ID: "ASIAYZFWRJC4VS2PRONF"
        AWS_SECRET_ACCESS_KEY: "7DXCAprM0sHxzPGpvCw9bpmrocWqULWPwCPgDibU"
        AWS_SESSION_TOKEN: "IQoJb3JpZ2luX2VjEK7//////////wEaCWV1LXdlc3QtMiJGMEQCIAMuNnXpwtkoe06UGN9VH2yhPkN2NOisAk6BXQAHP43nAiBShii0RHoAy8I+eCVmckqu0Q20tAjQ3n876a4nFXJkwiqoAwi3//////////8BEAMaDDYwMzgyNTcxOTQ4MSIM6wQrBe6dNSODhRkqKvwCjdEdemoDnfHXV27Ht7xkyyhViH193qfUJn31+6YVQGeDyluekIsDP2q7Up7jZbB8hE+bFX7YtW148jDVqmnHz0PBbIaQzGjwwGVJP0sgwOIYcnFOrot4I2cuSFnSe7IyhUFja/XMP8h7QGR6CZnm4gLhT/o1iBefUvrhjvA1mmtF2ed28TOBB4BIqHrMjH2deCE1BRkbBaGzoOkS14c6iXQmr9lregpEkt8iqQ61kKJGUHYmtdm9AQt+7OibSSrp0+gWvqF14gXbVIrejAOwirXfn7fnZG9eDBBgC7gbyC+D25a7IKHFcE5vjzIgODVGri/6PVvrqG93Q4QTTGw4jYJPxP+nB1L46UvLQqlWKYrK+lnhYVn+W5wEdwPsCizwh0aUoIVdPMjqahf2pC3J9X3dXTQxfJ13cqLIAmfWCvqW2QXxSqCOFJFTnorPD0zJulcQzFbb0LJBroeKJvtwoxWtV4f4w0vSiEIAvmhpFUefUSFyOpVe2fGJ0m0wi+ultgY6pwF8Q8dWW8XcYZS6DHigxxZMYR8Xr42Xf64eEwM4xqzAv9g2O5MOyd4b74aVZWAo/dS6mWVoApYg1KFdPg90hR+dsb3Pr8T8pmW/Sa/jXH/vGKkaUwiIg6+863y1KMdEAz35PbloDxrHJ0kGPbnwd2og6IeHWfLL8BJTH6tUIV5HVtTs3tT0PyYxhqEi5XiXvj0grDArqV8GFI+ZJMmdYZfWiDt5tmiJsQ=="

    - uses: fugue/regula-action@v3.2.1
      with:
        input_path: ./plan.json
        input_type: tf-plan
        rego_paths: policy_custom_rule/fugue_opa
