on: [push]

jobs:
  regula_tf_job:
    runs-on: ubuntu-latest
    name: Regula Terraform
    steps:
    - uses: actions/checkout@master
    - uses: fugue/regula-action@v3.2.1
      with:
        input_path: .
        rego_paths: policy_custom_rule/fugue_opa


  regula_tf_plan_job:
    runs-on: ubuntu-latest
    name: Regula on a Terraform plan JSON
    steps:
    - uses: actions/checkout@master
    - uses: hashicorp/setup-terraform@v1
      with:
        terraform_wrapper: false
        terraform_version: 1.2
    - run: |
        terraform init
        terraform plan -refresh=false -out="plan.tfplan"
        terraform show -json plan.tfplan > plan.json
        terraform destroy plan.tfplan
      env:
        # AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        # AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_ACCESS_KEY_ID: "ASIAYZFWRJC4WBUGECML"
        AWS_SECRET_ACCESS_KEY: "BRuXT5bjsjIcMwZwb4su3bPTYg9IQviKnwAKITpH"
        AWS_SESSION_TOKEN: "IQoJb3JpZ2luX2VjECcaCWV1LXdlc3QtMiJHMEUCIQCWU+SWN+lrFRSWlYqCSSVResqV46sWA8jB5iTqnpQcSQIgLS0NZPMr5EnhdvNK245fkchYsfWzSKjZrgyg9wBZiYUqnwMIPxADGgw2MDM4MjU3MTk0ODEiDA0UnYIWOce6XjPzXyr8AiYiD+HDPhGWIMFOCvObtgYJjCspYznHvxrDi0jxYri6rgYSSHnlUSOmC1aMdxS1TH0/4CIsoLmBatYvx97T/jfR8J/nOc8Y4MxtyLVaQPDySPDlriodjq8rEXPA+51IESxuQlDZfq7trK+aN+9VE/kXKN/0HYBzWPEibnUX4yX9ifQbpws1svNCbpwIOaY9WXcUR0VMBFNfWQ7JmYM5wI1s1L0KUGoKmAwJSjpku1quUn6N6tr3f5CBkTMAJFUfN7/StJCHeFJeIhsg4kUhKQbu04LLYlBcT4M3AqZMR6hZBGMrazvzJ/o2b3GsJYXqkx4I1X56Kh/ZjkqrOZWuq0hSpNa1w90wDAqXRJoQcMH7BUcAmhk3ksD6D/zacntSzkSWzTtRY2Xem4ttOtWBHLxlvHOiUfL5yuRHY8VfkXQrqRfGVV/IyxUhBaO0OTdWPt9vtdKXVTTFckGSuz+P/UPVDZe1eiz+735Fwds61KYUmbbr/ucAqZ3hiDfoMI6kwLYGOqYBJClEgWHi+Rw7MgNMaxjlmBdgJg88vTYU08tzpouLeygeJQ6fVCnuJ8OK5+vvfD7JbbA6guBmmmIN6Y+oktCLRyL9Ezw2WLSRpHJnBmjAIDV9a7ERqd2tw9lJDTz3Aq3Cb3DwyqCXLcw0s0jpvR7hzJYIhzkeVlyktGP67noMJeIGYmAYWH62562s3CL5VTfwvdZRO6Wm+EgCG0WcrhaBlz4czWk7xA=="

    - uses: fugue/regula-action@v3.2.1
      with:
        input_path: ./plan.json
        input_type: tf-plan
        rego_paths: policy_custom_rule/fugue_opa
