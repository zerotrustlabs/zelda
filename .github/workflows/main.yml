on: [push]

jobs:
  regula_tf_job:
    runs-on: ubuntu-latest
    name: Regula Terraform
    steps:
    - uses: actions/checkout@master
    - uses: fugue/regula-action@v3.2.1
      with:
        input_path: .
        rego_paths: policy_custom_rule/fugue_opa


  regula_tf_plan_job:
    runs-on: ubuntu-latest
    name: Regula on a Terraform plan JSON
    steps:
    - uses: actions/checkout@master
    - uses: hashicorp/setup-terraform@v1
      with:
        terraform_wrapper: false
        terraform_version: 1.2
    - run: |
        terraform init
        terraform plan -refresh=false -out="plan.tfplan"
        terraform show -json plan.tfplan > plan.json
      env:
        # AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        # AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_ACCESS_KEY_ID: "ASIAYZFWRJC4TVJGMHEF"
        AWS_SECRET_ACCESS_KEY: "iuQ+j61eceM/jxoj47gyv5fKtxOEBSrt4G40YKBb"
        AWS_SESSION_TOKEN: "IQoJb3JpZ2luX2VjEN///////////wEaCWV1LXdlc3QtMiJGMEQCICgFrpBJdKkbRBp1Iuv4aUcbinKt+5XMBMadBP9TIhZ3AiA2wi9LPrsOpOvZ6dJAV1BawtziOOT7wfZdk8hmr/thEiqoAwjo//////////8BEAMaDDYwMzgyNTcxOTQ4MSIMUTDzppSux7oIJ1PwKvwCegwdtl8lfAhMuzYFnPNdvQvLdOKWoovG5/V8/3J2zXtAtDmgEGYldJUOZUuIdY2h+WYhqMHmrD6FtjbwLMPEVvQbewk7vHVljBMtw7m/uFoRiK+GTPplHG49uSiBD5YNNwLijKdUl7ZRFaI39JUsCqFKrnVAj2yqFKaYaQm8bwZZdYtJYogtoNKoJV2BxUUsMNl0PFJFvNi1zHivYpCauv87oOVN1GHvy3Em4g12In/QOgiYEJ1x2/ZnyfI5UgLNCj6JQp8HaU+hWs+SMWHzo8fgXliI3py1qfqIh5bWCHjJbSNaDgZBSBlBu2SMkIqMgEsbqrl/kvOZW9ZiOQAU5Lang20o7om1pnAKmkBMflk9EZGgbITHd7bd/w/DMoDwWZDciB7AUHXobUwAo6eMRMe3VI745Jsy50XtXarnSMwactLeULuFgJBpSGdvQe5e5x/R3hOi2ELfB4SAu9NlauPYjxkCyq4KFQgJPhxOhfUqMG5psolD9frsV0gw8cKwtgY6pwFRN1rbWBQ6ogbppLr5nbB/RyTUc1N2fCvqfl/D820n7dvePvRAwlHv/NZCAitT/io7gnVx7yUtEV8DiePuVY4Xweyh9ElMhMmdeaEkSpYOuC+umYmaYGMcWyT0s+Y0Y8BBfbImF0lxFCaAxKjpyLeGsSrqbONpw7gvc3NXHy7UbuTJGR7T1MdOW9DfHSJFEPbEZQ3fddtlCit+KwkMNj7Amyha/TApZg=="

    - uses: fugue/regula-action@v3.2.1
      with:
        input_path: ./plan.json
        input_type: tf-plan
        rego_paths: policy_custom_rule/fugue_opa
